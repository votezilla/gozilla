{{define "body"}}
{{ template "beginFrame" . }}
	{{/* Header w/ banner + nav menu. */}}
	<table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f6f6ef">
		<!-- votezilla logo -->
		<tr><td bgcolor="#ff6600">
			<div width=100% style="background-color:white">
				<a href='/news'>
					<img src='/static/votezilla logo/votezilla 6.jpg' class="center" style="max-width:100%">
				</a>
			</div>
		</td></tr>

		<tr><td bgcolor=white>
			<table border="0" cellpadding="0" cellspacing="0" width="100%" style="padding:4px; font-size: 20px;">
				<tr>
					<td style="width:18px; padding:1px">
						<div style="border: 1px solid black; color: black; text-align:center;"><span style="color:#ff009c">v</span><span style="color:#0072ff">z</span></div>
					</td>
					<td style="line-height:12pt; height:10px; padding: 0px 5px; color:white !important;">
						<span class="pagetop">
							<!-- votezilla logo -->
							<b id="votezilla_title">
								<a href="/news" style="color:#ff009c">vote<span style="color:black">zilla</span></a>
							</b>
						<!-- nav menu -->
						{{- range $i, $navItem := .NavMenu}}
							{{- if ne $i 0 }} | {{end -}}
							{{- if eq $navItem $.UrlPath}}<span class="topsel">{{end -}}
							<a href="/{{$navItem}}"
							   style="color: {{- if eq $navItem $.UrlPath}}#0072ff{{else}}black{{end}};"
								{{- if eq $navItem "create" -}} target="_blank" {{- end -}}
							>
								{{$navItem}}
							</a>
							{{- if eq $navItem $.UrlPath}}</span>{{end -}}
						{{end -}}
						</span>
					</td>
					<td style="text-align:right; padding-right:4px;">
						<!-- login / register / logout -->
						<span class="pagetop">
							{{- if .Username }}
								<a href="/user?id={{.Username}}">{{.Username}}</a> | <a href="/logout">logout</a>
							{{- else -}}
								<a href="/login" target="_blank">log in</a>
								<!--
								<a data-target="#myModal" data-toggle="modal" data-path="login" data-title="Log In" style="cursor:pointer">
									log in
								</a>-->
								/
								<a href="/register" target="_blank">sign up</a>
								<!--
								<a href="/register">
								<a data-target="#myModal" data-toggle="modal" data-path="register" data-title="Sign Up" style="cursor:pointer">
									sign up
								</a>-->
							{{end -}}
						</span>
					</td>
				</tr>
			</table>
		</td></tr>
	</table>

	{{ template "content" . }}
{{ template "endFrame" . }}

<!-- Modal popup body -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header" style="background-color:#edf0f5">
				<h1 class="modal-title" id="myModalLabel" style="align:center;">
					Sign Up
				</h1>
				<button type="button" class="btn btn-default" data-dismiss="modal"
						style="font-size: 40px; padding: 0; position:absolute; right:20px; cursor: pointer !important; border-radius: 2rem; background-color:#edf0f5;">
					&times;
				</button>
			</div>

			<div class="modal-body" style="background-color:white"></div><!--#edf0f5-->
		</div>
	</div>
</div>

<script>

///////////////////////////////////////////////////////////////////////////////
//
// MODAL POPUP VOTING
//
///////////////////////////////////////////////////////////////////////////////

// Modal popup handler
$('#myModal').on('show.bs.modal', function(e) {
	var rt = $(e.relatedTarget);

	var path = rt.data('path');

	if (path == null) {
		alert("Modal's data-path parameter is null.");
		return;
	}

	console.log("path = " + path);

	var title = rt.data('title');
	console.log("title = " + title);
	$('.modal-title').text(title);

	// Allow custom modal popup behavior.
	if (window[path + "_Modal"] != null) {
		window[path + "_Modal"](rt);  // This calls a custom modal handler, i.e. viewPollResults_Modal(rt).
		return;
	}

	$('.modal-body').load(`/${path}/`, function() { // works, now also testing...
		console.log('Load was performed');

		$('.modal').modal({show: true});
	});
});

///////////////////////////////////////////////////////////////////////////////
//
// ALERT
//
///////////////////////////////////////////////////////////////////////////////
$(function() {
	let params = new URLSearchParams(location.search);
	alertMsg = params.get('alert');
	if (alertMsg) {
		alert(alertMsg);
	}
})

///////////////////////////////////////////////////////////////////////////////
//
// POST VOTING
//
///////////////////////////////////////////////////////////////////////////////

loggedIn = {{ if .Username }} true {{ else }} false {{ end }} ;

var votedPosts = [[[], []], [[], []]];

function removeItem(arr, item) {
	var index = arr.indexOf(item);
	if (index > -1) {
	    arr.splice(index, 1);
	}
}

// Whether an upvote or down with this id is enabled.
function hasVote(id, up, bcomment) {
	return votedPosts[up ? 1 : 0][bcomment ? 1 : 0].includes(id)
}

// Add or remove the voting state.  Also updates the vote tally text.
function addOrRemoveVoteState(id, add, up, bcomment) {
	if (add) {
		votedPosts[up ? 1 : 0][bcomment ? 1 : 0].push(id)

	} else { // remove
		removeItem(votedPosts[up ? 1 : 0][bcomment ? 1 : 0], id)
	}
}

// Increment or decrement vote tally text.
function incVoteLabel(id, bcomment, voteInc) {
	if (bcomment) {
		label = $("#votetallyComment" + id)
	} else {
		label = $("#votetally" + id)
	}
	count = parseInt(label.text())
	label.text(count + voteInc)
}

// Add or remove a vote via state, CSS, and updating of database via AJAX.
function addOrRemoveVote(id, add, up, bcomment, updateDatabase, updateText) {
	// state
	addOrRemoveVoteState(id, add, up, bcomment)

	// glowing arrow CSS
	if (bcomment) {
		if (add) {
			if (up) {
				$("#upvoteComment" + id).addClass("upvoted")
			} else {
				$("#downvoteComment" + id).addClass("downvoted")
			}
		} else { // remove
			if (up) {
				$("#upvoteComment" + id).removeClass("upvoted")
			} else {
				$("#downvoteComment" + id).removeClass("downvoted")
			}
		}
	} else {
		if (add) {
			if (up) {
				$("#upvote" + id).addClass("upvoted")
			} else {
				$("#downvote" + id).addClass("downvoted")
			}
		} else { // remove
			if (up) {
				$("#upvote" + id).removeClass("upvoted")
			} else {
				$("#downvote" + id).removeClass("downvoted")
			}
		}
	}

	// vote tally text
	if (updateText) {
		incVoteLabel(id, bcomment, (add && up || !add && !up) ? 1 : -1)
	}

	// AJAX - database state
	if (updateDatabase) {
		$.ajax({
			url: '/ajaxVote/',
			type: "post",
			contentType: 'application/json; charset=utf-8',
			data: JSON.stringify({PostId: id, Add: add, Up: up, IsComment: bcomment}), // Hmmm <-- should be UserId not Username
			dataType: 'json',
			success: function(r) { console.log("AJAX - success"); },
			error:   function(r) { console.log("AJAX - error"); }
		});
	}
}

// Cancel an up or down vote
function cancelVote(id, up, bcomment) {
	if (hasVote(id, up, bcomment)) {
		addOrRemoveVote(id, false, up, bcomment, false, true) // cancel
	}
}

// Toggle an up or down vote
// (Only toggleVote should send the AJAX, otherwise there will be a race condition in updating the database.)
function toggleVote(id, up, bcomment) {
	if (hasVote(id, up, bcomment)) {
		addOrRemoveVote(id, false, up, bcomment, true, true) // cancel.
	} else {
		addOrRemoveVote(id, true,  up, bcomment, true, true) // enable
	}
}

// Vote up or down on a post.  Or if already voted, cancels the vote.
// id: postId
// up: true for up, false for down
function Vote(id, up, bcomment) {
	if (loggedIn) {
		cancelVote(id, !up, bcomment) // cancel opposite type of vote
		toggleVote(id, up, bcomment)  // toggle this type of vote
	} else {
		alert("You must be logged in to do that!")
	}
}

// On load, set the style for the up/down votes that the user has already voted on.
$(function() {
    {{ range $_, $id := $.UpVotes}}
    	addOrRemoveVote({{$id}}, true, true, false, false, false)  // Add a upvote presentation, but do not update the database.
    {{ end }}
    {{ range $_, $id := $.DownVotes}}
	    addOrRemoveVote({{$id}}, true, false, false, false, false) // Add a downvote presentation, but do not update the database.
    {{ end }}
});


///////////////////////////////////////////////////////////////////////////////
//
// POLL VOTING
//
///////////////////////////////////////////////////////////////////////////////

// Get the vote data from the form - how the user voted on this poll, i.e. what their vote is.
function getVoteData(pollId, numOptions, pollType) {
	console.log(`getVoteData(${pollId}, ${pollType})`);

	console.log(`numOptions = ${numOptions}`);

	var voteData = [];

	for (var o = 0; o < numOptions; o++) {
		switch(pollType) {
			case "radio":
			case "checkbox":
				voteData.push($(`#vote_${pollId}_${o}`).is(':checked') ? "x" : "");
				break;
			case "text":
				var val = $(`#vote_${pollId}_${o}`).val();
				// Convert undefined to ''.
				if (!val) {
					val = '';
				}
				voteData.push(val);
				break;
			default:
				alert("Unhandled poll type AAA: " + pollType);
		}
	}
	console.log(voteData);

	return voteData;
}

function ordinal(num) {
	switch(num) {
		case 1: return "1st";
		case 2: return "2nd";
		case 3: return "3rd";
		default: return `${num}th`;
	}
}

function validateVoteData(pollType, voteData) {
	switch(pollType) {
		case "radio":
		case "checkbox": // Multiple choices valid
			console.log(voteData);

			valid = voteData.reduce((a, b) => a || b)  // OR all the choices together.
			console.log("valid = " + valid);

			if (!valid) {
				alert(`You must select ${pollType == "checkbox" ? "at least " : ""}one option`);
			}

			return valid; // Make sure one is picked.
		case "text": // Ranked voting
			sorted = voteData.filter(x => x != "").sort(); // creates a copy of voteData, then sorts it

			console.log(voteData);
			console.log(sorted);

			// Check for valid ranked voting, i.e. "1", "2", ...
			if (sorted[0] != "1") {
				alert('You must mark your 1st choice with a "1"');
				return false;
			}
			var gap = false;
			for (var i = 1; i < sorted.length; i++) {
				if (sorted[i] != (i + 1).toString(10)) {
					alert(`You must mark your ${ordinal(i + 1)} choice with a "${i + 1}" (if you care to pick one).`);
					console.log("return false");
					return false;
				}
			}
			console.log("return true");
			return true;
		default:
			alert("Unhandled poll type BBB: " + pollType);
			return false;
	}
}

function VoteOnPoll(pollId, numOptions, pollType) {
	if ({{.UserId}} == -1) {
		alert("You must be logged in to do that!");  // TODO: make this a modal that prompts for login / register

		return;
	}

	console.log("pollId = " + pollId);
	console.log("numOptions = " + numOptions);
	console.log("pollType = " + pollType);
	console.log("userId = " + {{.UserId}});

	voteData = getVoteData(pollId, numOptions, pollType);

	console.log({PollId: pollId, VoteData: voteData});

	if (validateVoteData(pollType, voteData)) { // Check if voting data is valid.
		console.log("valid vote data");

		// Place poll vote
		$.ajax({
			url: '/ajaxPollVote/',
			type: "post",
			contentType: 'application/json; charset=utf-8',
			data: JSON.stringify({PollId: pollId, VoteData: voteData}),
			dataType: 'json',
			success: function(r) {
				console.log("AJAX Poll Vote - success");

				console.log(r);

				// Open the View Poll Results in a new tab.
				window.open(`/viewPollResults/?postId=${pollId}`, '_blank');
			},
			error: function(r) {
				console.log("AJAX Poll Vote - error");

				alert("Vote failed for some reason.");
			}
		});
	} else {
		// Cancel opening the modal
		console.log("invalid vote data");
	}
}

///////////////////////////////////////////////////////////////////////////////
//
// MODALS
//
///////////////////////////////////////////////////////////////////////////////
var triggerModalDataTargetAnchor = "";
//var triggerModalId = "";

function onClick_OpenModalLink(modalDataTargetAnchor) {
	console.log("onClick_OpenModalLink: modalDataTargetAnchor = " + modalDataTargetAnchor);

	triggerModalDataTargetAnchor = modalDataTargetAnchor;
	$('#myModal').modal('hide');
}

// After onClick_OpenModalLink, the window close generates the following callback. */
$('#myModal').on('hidden.bs.modal', function (e) {
	if (triggerModalDataTargetAnchor) {
		$( "#myModal" ).modal( "show", $( "#"+triggerModalDataTargetAnchor ) );  // The caller must define an anchor with id="theTarget".

		triggerModalDataTargetAnchor = "";
	}
})




// TOOLTIP

$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})

</script>

{{end}} {{/*body*/}}


///////////////////////////////////////////////////////////////////////////////
//
// UTILITY TEMPLATE FUNCTIONS
//
///////////////////////////////////////////////////////////////////////////////

{{ define "PostVoteWidget" }}
	{{ $article := . }}
	<td align="left" style="width: 40%;">
		<span class="upvote" id="upvote{{$article.Id}}">
			<a href="javascript:Vote({{$article.Id}}, true, false)" class="upvote" data-toggle="tooltip" data-placement="top" title="Up vote">&#x25B2;</a>
		</span>
		<a id="votetally{{$article.Id}}">{{$article.VoteTally}}</a>
		<span class="downvote" id="downvote{{$article.Id}}">
			<a href="javascript:Vote({{$article.Id}}, false, false)" class="downvote" data-toggle="tooltip" data-placement="top" title="Down vote">&#x25BC;</a>
		</span>
	</td>
{{ end }}

{{ define "CommentVoteWidget" }}
	{{ $tag := . }}
	<td align="left" style="width: 40%;">
		<span class="upvote" id="upvoteComment{{$tag.Id}}">
			<a href="javascript:Vote({{$tag.Id}}, true, true)" class="upvote" data-toggle="tooltip" data-placement="top" title="Up vote">&#x25B2;</a>
		</span>
		<a id="votetallyComment{{$tag.Id}}">{{$tag.VoteTally}}</a>
		<span class="downvote" id="downvoteComment{{$tag.Id}}">
			<a href="javascript:Vote({{$tag.Id}}, false, true)" class="downvote" data-toggle="tooltip" data-placement="top" title="Down vote">&#x25BC;</a>
		</span>
	</td>
{{ end }}

{{ define "VoteOnPollHandler" }}
	{{- $article := . -}}
	{{- $poll := $article.PollOptionData -}}
	onClick="VoteOnPoll(
		{{- $article.Id }},
		{{- len $poll.Options }},
		{{- if $poll.RankedChoiceVoting }}
			{{- "text" }}
		{{- else if $poll.CanSelectMultipleOptions }}
			{{- "checkbox" }}
		{{- else }}
			{{- "radio" }}
		{{- end -}}
	)"
{{ end }}


{{ define "PollTallyResults" }}
	<!--<tr><td><i>Results:</i></td></tr>-->
	{{- $article := . -}}
	{{- $poll := $article.PollOptionData -}}
	{{- $pollTallyResults := $article.PollTallyResults -}}
	{{/*- $vote := $article.VoteData -*/}}
	{{- $maxOptions := 0 }}
	{{- if eq $article.Size 1 }}     {{/*LARGE ARTICLE SIZE*/}}
		{{- $maxOptions = 8 }}
	{{- else if eq $article.Size 0 }}{{/*NORMAL ARTICLE SIZE*/}}
		{{- $maxOptions = 3 }}
	{{- else }}                      {{/*2 - FULLPAGE ARTICLE */}}
		{{- $maxOptions = 999999 }}
	{{ end }}

	{{ range $o, $option := $poll.Options }}
		{{ if lt $o $maxOptions }}
			{{ $percentage := printf "%.0f%%" (index $pollTallyResults $o).Percentage }}
			<tr>
				<td style="min-width: 30%; max-width: 50%;
						   word-break: break-word;
						   -ms-word-break: break-all;
						   vertical-align: top;">
					{{$option}}
				</td>
				<td width=10% align=right style="padding-right: 5px;">{{(index $pollTallyResults $o).Count}}</td>
				<td width=30% nowrap>
					<div class="w3-border" style="position:relative">
						<div class="w3-grey" style="height:24px; width:{{$percentage}}"></div>
					</div>
				</td>
				<td width=5% style="padding-left: 5px; padding-right: 5px;">{{$percentage}}</td>
				<td width=5%>{{ if (index $article.VoteData $o) }}<img width=24 height=24 src="/static/reddit checkbox.png">{{ end }}</td>
			</tr>
		{{ else if eq $o $maxOptions }}
			<tr><td colspan=5><label class="vote">
				<a href="/viewPollResults/?postId={{ $article.Id }}" target="_blank" style="font-size: 18px; color: #0072ff; margin-left: 8px;">
					More...
				</a>
			</td></label></tr>
		{{ end }}
	{{ end }}
{{ end }}

{{ define "PollTallyResultsInline" }}
	<table width=100%>
		<tr></tr>
<!--		<tr>
			<td colspan=3><h5><b>Results below:</b></h4></td>
		</tr>
-->		{{ template "PollTallyResults" . }}
	</table>
{{ end }}


{{ define "PollInlineForm" }}
	{{- $article := . -}}

	{{- $maxOptions := 0 }}
	{{- if eq $article.Size 1 }} {{/*LARGE ARTICLE SIZE*/}}
		{{- $maxOptions = 8 }}
	{{- else }}
		{{- $maxOptions = 3 }}
	{{ end }}

	{{- if $article.IsPoll -}}
		{{ if $article.WeVoted }}
			{{ template "PollTallyResultsInline" $article }}
		{{ else }}
			{{/*$article.Id*/}}
			{{- $poll := $article.PollOptionData }}
			{{ if $poll.RankedChoiceVoting }}
				<div>
					<div style="width: 100%; padding-left: 5px;">
						<i>Ranked Vote: 1 = 1st choice, 2 = 2nd choice, etc.</i>
					</div>
				</div>
			{{ end }}
			<div valign="top">
				<div style="width: 100%; padding-left: 5px;">
					<div width="100%">
						<div>
							<div align="left">
								{{ range $o, $option := $poll.Options }}
									{{ if lt $o $maxOptions }}
										{{ if $poll.RankedChoiceVoting }}
											<label class="vote">
												<input id="vote_{{$article.Id}}_{{$o}}" type="digit" class="rankedVote" value="" size="1" maxlength="1">
												{{$option}}
											</label>
										{{ else if $poll.CanSelectMultipleOptions }}
											<label class="vote">
												<input id="vote_{{$article.Id}}_{{$o}}" type="checkbox" class="vote" value="{{$o}}">
													{{$option}}
											</label>
										{{ else }}
											<label class="radio-inline vote" style="cursor: pointer">
												<input id="vote_{{$article.Id}}_{{$o}}" type="radio" class="vote"
													   name="vote_{{$article.Id}}" {{ if eq $o -1 }} checked {{ end }}>
												{{$option}}
											</label>
										{{ end }}
										<br>
									{{ else if eq $o $maxOptions }}
										<label class="vote">
											<a href="{{$article.Url}}&changeVote=true" target="_blank" style="font-size: 18px; color: #0072ff; margin-left: 8px;">
												More options...
											</a>
										</label>
										<br>
									{{ end }}
								{{ end }}

								<span style="padding-left: 5px;">
									<button type="submit" class="btn btn-vote btn-sm" style="margin: .5rem 0;" {{template "VoteOnPollHandler" $article}}>Vote!</button>
								</span>
							</div>
						</div>
					</div>
				</div>
			</div>
		{{ end }}
	{{ end }}
{{ end }}


{{ define "PollForm" }}
	{{- $article := . -}}
	{{- if $article.IsPoll -}}
		{{- $poll := $article.PollOptionData }}
		<tr valign="top">
			<td class="title" style="padding-left: 5px;">
				<table width="100%">
					{{ if $poll.RankedChoiceVoting }}
						<tr><td align="left">
							<span class="rankedVoteIntro">
								Ranked Vote: 1 = 1st choice, 2 = 2nd choice, etc.
							</span>
							<br>
						</td></tr>
					{{ end }}
					<tr><td align="left">
						{{ range $o, $option := $poll.Options }}
							{{ if $poll.RankedChoiceVoting }}
								<div>
									<label>
										<input id="vote_{{$article.Id}}_{{$o}}" type="digit" value="" size="1"
											   maxlength="1" style="width: 25px; padding: 5px; margin: 4px 4px 4px 0;">
											   {{$option}}
									</label>
								</div>
							{{ else if $poll.CanSelectMultipleOptions }}
								<div>
									<label class="vote">
										<input id="vote_{{$article.Id}}_{{$o}}" type="checkbox" class="vote"
										   	   value="{{$o}}" style="margin: 6px;">
										{{$option}}
									</label>
								</div>
							{{ else }}
								<div>
									<label class="vote" style="margin-bottom: 0">
										<input id="vote_{{$article.Id}}_{{$o}}" type="radio" class="vote"
											   name="vote_{{$article.Id}}" {{ if eq $o -1 }} checked {{ end }}
											   style="margin: 8px;">
										{{$option}}
									</label>
								</div>
							{{ end }}
						{{ end }}

						<input name="vote_{{$article.Id}}_len" type=hidden value="{{len $poll.Options}}">

						<button type="submit" class="btn btn-vote" style="margin: 1rem 0;" {{template "VoteOnPollHandler" $article}}>Vote!</button>
					</td></tr>
				</table>
			</td>
		</tr>
		<tr class="spacer" style="height:10px"></tr>
	{{ end }}
{{ end }}

{{ define "BackToCategory" }}
	<table width="100%"><tr>
		<td align="left" style="width: 10%">
			<span class="pagetop" style="font-size: 20px; margin-top: 1rem; margin-bottom: 1rem;">
				<a href="/news/?category={{.}}" style="color: #003980; font-size: 20px;">
					<i class="fa fa-caret-left" style="font-size:36px; vertical-align:middle;"></i>
					{{ . }}
				</a>
			</span>
		</td>
		<td align="right" style="width: 10%">
			<span class="pagetop" style="font-size: 20px; margin-top: 1rem; margin-bottom: 1rem;">
				<a href="/news" style="color: #003980; font-size:28px; vertical-align:middle;" onclick="window.close();">
				  <h5 style="color: #003980; margin: 5px;">
					<i class="fa fa-times" aria-hidden="true" style="font-size:36px; vertical-align:middle; "></i>
				  </h5>
				</a>
			</span>
		</td>
	</table>
{{ end }}

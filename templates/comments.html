{{define "AddCommentWidget"}}
	<p>
		<div class="comment" id="comment_{{ . }}">
			<table>
				<tr>
					<td valign=top>
						<img src="/static/dino comment.jpg" width=32 style="vertical-align: baseline;">
					</td>
					<td>
						<textarea id="text_{{ . }}" value="" placeholder="Add a comment" length="50" class="nuField3" rows="4" cols="80" style="height:default; width: 100%; max-width: 100%; margin-top: 0;"></textarea>
					</td>
				</tr>
				<tr>
					<td></td>
					<td align=right>
						<button type="submit" onclick="onReplyToCommentClicked({{ . }})" class="btn btn-vote" style="margin: .5rem 0;">
							Comment
						</button>
					</td>
				</tr>
			</table>
		</div>
	</p>
{{end}}




{{/* TODO: try recursiveness - template "comments" .Comments */}}

{{define "comments"}}

	{{$postId := .Article.Id}}

	<style>
	.nuField2, .nuField2:focus {
		width:90%;
		max-width:90%;
		height:40px;
		border-radius:5px 5px 5px 5px;
		background:white;
		padding:10px;
		font-size:18px;
		margin-top:8px;
		border-width: 1px;
		border-style:solid;
		border-color: gray;
		resize: both;
	}
	.nuField2:focus {
		outline: none;
		box-shadow: 0px 0px 5px 1px #0066ff;
	}
	.nuField2:not(focus) {
		background-color: #eee;
		color: #666;
	}

	.nuField3, .nuField3:focus {
		width:90%;
		max-width:90%;
		border-radius:5px 5px 5px 5px;
		background:white;
		padding:10px;
		font-size:18px;
		margin-top:8px;
		border-width: 1px;
		border-style:solid;
		border-color: gray;
		resize: both;
	}
	.nuField3:focus {
		outline: none;
		box-shadow: 0px 0px 5px 1px #0066ff;
	}
	.nuField3:not(focus) {
		background-color: #eee;
		color: #666;
	}
	</style>

	<div class="vzcomment">
	<!--
		<p>
			<span class="comment" id="comment_-1">
				<a href="javascript:ReplyToComment({{$postId}}, -1)">
				<img src="/static/dino comment.jpg" width=32>
					Write a Comment
				</a>
			</span>
		</p>
	-->

		{{ template "AddCommentWidget" -1 }}
	<!--
		<p>
			<div class="comment" id="comment_-222">
				<table>
					<tr>
						<td valign=top>
							<img src="/static/dino comment.jpg" width=32 style="vertical-align: baseline;">
						</td>
						<td>
							<textarea name="comment_-222" value="" placeholder="Add a comment" length="50" class="nuField3" rows="4" cols="80" style="height:default; width: 100%; max-width: 100%; margin-top: 0;"></textarea>
						</td>
					</tr>
					<tr>
						<td></td>
						<td align=right>
							<button type="submit" class="btn btn-vote" style="margin: .5rem 0;">
								Comment
							</button>
						</td>
					</tr>
				</table>
			</div>
		</p>
	-->

		<p>

		{{ range $t, $tag := .Comments -}}{{/* CommentTags */}}
		{{- if $tag.IsChildrenStart -}}
				<div class="vzcomment_children">
					<div class="vzcomment">
			{{- else if $tag.IsChildrenEnd -}}
					</div>
				</div>
			{{- else -}} {{/* comment text */}}
				<p class="vztagline">
					<a href="#" target="_blank">
						<span><img src="/static/mozilla%20dinosaur%20head.png" width=16 height=16></span>
						<span style="color: #88f;">{{$tag.Username}}</span>
					</a>

					<p>{{$tag.Text}}
					<p>
					<span id="comment_{{$tag.Id}}" style="size: 16px">
						<a href="javascript:ReplyToComment({{$postId}}, {{$tag.Id}})">
							<img src="/static/comment.png" width="16" height="16"> Reply
						</a>
					</span>
				</p>
			{{- end -}}
		{{- end }}
	</div>



	<script>

	///////////////////////////////////////////////////////////////////////////////
	//
	// COMMENTING FUNCTIONS
	//
	///////////////////////////////////////////////////////////////////////////////


	// Reply to the comment with this id.
	function ReplyToComment(postId, parentId) {
		parent = document.getElementById(`comment_${parentId}`);

		console.log(parentId);
		console.log(parent);

		// Insert create comment button.
	/*	var html = `<p>
					<table>
						<tr>
							<td valign="bottom">
								<textarea id="text_${parentId}" rows="4" cols="60"></textarea>
							</td>
							<td valign="bottom">
								<button type="submit" id="reply_button_${parentId}" onclick="onReplyToCommentClicked(${postId}, ${parentId})" class="save" style="margin: 5.5px;">
									Create
								</button>
							</td>
						</tr>
					</table>
				</p>`;
	*/

		var html = `<p>
				<div class="comment" id="comment_${parentId}">
					<table>
						<tr>
							<td valign=top>
								<img src="/static/dino comment.jpg" width=32 style="vertical-align: baseline;">
							</td>
							<td>
								<textarea id="text_${parentId}" name="text_${parentId}" value="" placeholder="Add a comment" length="50" class="nuField3" rows="4" cols="80" style="height:default; width: 100%; max-width: 100%; margin-top: 0;"></textarea>
							</td>
						</tr>
						<tr>
							<td></td>
							<td align=right>
								<button type="submit" onclick="onReplyToCommentClicked(${parentId})" class="btn btn-vote" style="margin: .5rem 0;">
									Comment
								</button>
							</td>
						</tr>
					</table>
				</div>
			</p>`;

		console.log(html);

		parent.insertAdjacentHTML('beforeend', html);

		$(`#reply_button_${parentId}`).focus();  // Focus on the new comment.
	}

	function onReplyToCommentClicked(parentId) {
		console.log(`#text_${parentId}`);

		if (!loggedIn) {
			alert("You must be logged in to do that!") // TODO: this should be a modal dialog that gives them the option to log in.
			return;
		}

		var text = $(`#text_${parentId}`).val();

		console.log(text);

		data = JSON.stringify({
				PostId:	  {{ $postId }},
				ParentId: parentId,
				Text: 	  text});

		console.log(data);

		$.ajax({
			url: '/ajaxCreateComment/',
			type: "post",
			contentType: 'application/json; charset=utf-8',
			data: data, // Hmmm <-- should be UserId not Username
			dataType: 'json',
			success: function(r) {
				console.log("AJAX - success");
				console.log("r.Id: "   + r.Id);
				console.log("r.Text: " + r.Text);

				// Inject new comment html for the new comment.
				var parent = document.getElementById(`comment_${r.ParentId}`);
				parent.insertAdjacentHTML('beforeend',  // Note: this HTML code is duplicated in comments.html
					`<p class="vztagline">
						<a href="#" onclick="return togglecomment(this)">[&ndash;]</a>
						<a href="#">{{.Username}}</a>
					 </p>
					 <p>${r.Text}</p>
					 <p>
						<span id="comment_${r.Id}" style="size: 16px">
							<a href="javascript:ReplyToComment(${r.PostId}, ${r.Id})">
								<img src="/static/comment.png" width="16" height="16"> Reply
							</a>
						</span>
					 </p>`);

				// Focus on the new comment
				document.getElementById(`comment_${r.Id}`).focus();

				console.log(`$("#text_${r.ParentId}").remove();`);

				// Remove the old new comment form inputs.
				// Note: Due to some jquery weirdness, I can't find a subtree remove, just yet.
				document.getElementById(`text_${r.ParentId}`).remove();
				document.getElementById(`reply_button_${r.ParentId}`).remove();
			},
			error:   function(r) { console.log("AJAX - error"); }
		});
	}

	</script>

{{end}} {{/*comments*/}}